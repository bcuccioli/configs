#!/usr/bin/env -S ansible-playbook

---
 - hosts: all
   gather_facts: no
   remote_user: blc

   tasks:
       - name: Upgrade all packages
         apt: upgrade=dist update_cache=yes
         become: yes

       - name: Rebooting if needed
         command: shutdown -r now removes=/var/run/reboot-required
         become: yes
         async: 0
         poll: 0
         ignore_errors: true
         register: restarted

       - name: Waiting for reboot...
         local_action: wait_for host=localhost port=22 delay=15 state=started
         when: restarted.changed

       - name: Install unattended-upgrades
         apt: name=unattended-upgrades state=present
         become: yes

       - name: Configure unattended-upgrades
         replace: 
             path=/etc/apt/apt.conf.d/50unattended-upgrades
             regexp='^//      "origin=Debian'
             replace='        "origin=Debian'
         become: yes

       - name: Clean up apt caches
         apt:
             autoclean: yes
             autoremove: yes
         become: yes
