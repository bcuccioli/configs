#!/usr/bin/env -S ansible-playbook --ask-vault-pass

---
  - hosts: all
    vars:
      - server_pw: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            38613933616637633161356536636437623466623931386637636136393736396262666661383465
            3662326635343031326531313838303237646135666333300a653662343665626662336131636563
            37616635663030653530326631343633373330643265633439303433323333346565363965653963
            6562633161613065300a326139653032646566343262626661636238373564613238656330623639
            3931
      - acct_pw: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            38613933616637633161356536636437623466623931386637636136393736396262666661383465
            3662326635343031326531313838303237646135666333300a653662343665626662336131636563
            37616635663030653530326631343633373330643265633439303433323333346565363965653963
            6562633161613065300a326139653032646566343262626661636238373564613238656330623639
            3931
      - client_id: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            65633633666435303263313262363235393064613039383565366663336636313432316139383336
            6438663832323665353565663034666538323336633530380a636337613164343135353162656638
            38366236356633643139356338616534333338656638666361633635616363393562633965623764
            6265303635316633350a383231633032643861343034643565333362366163336164623036653239
            3837
      - client_secret: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            62366530313462323537383638306439336234643435366365366365333965316236376164323564
            6334313738393734363266366235616363653433326532630a396138376566383537393362653631
            37623936343936356232366538333138616661356133656262383733633064373564663234366266
            3736383039313731630a313835643362373861666665343532366235333832353863303937663461
            30643231323538333531616630363566393533636461623133666137663263343462
      - canary_name: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            62353532626263376234303136383835323639643738396561646661336666313039303964366164
            3163363331353439303331663030633439643837336263630a346433663134616465623239323965
            37353062613035353235636366383738616263386433656438343437646164633166626563626536
            3035303337323237660a336662333630346534313263353231323665376630336131663366366665
            6661
      - canary_token: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            33316237323738393766613235636234386162373436306466633836336261616566363339653862
            3966306437663633386131316465356334386639643837360a353266393536636132616464356461
            33613430313462643363326566353337343935646563313638373831363939373732393831366261
            6661316236386165310a373937376461643439656437356163313938306266326634656135306635
            31346664306430613331396664613966623931323236393038646237323431653339646236353464
            3962336637313163333436666538356234613737343731316132
    gather_facts: no
    remote_user: blc

    tasks:
      - name: git clone chirrrrp
        git:
          repo: https://github.com/bcuccioli/chirrrrp.git
          dest: ~/chirrrrp
          update: no

      - name: Copy config template
        shell: "cp ~/chirrrrp/config/config.json.example ~/chirrrrp/config/config.json"

      - name: Replace lines in config
        replace:
          path: ~/chirrrrp/config/config.json
          regexp: '{{ item.a }}'
          replace: '{{ item.b }}'
        with_items:
         - { a: '<SERVER_PW>',     b: '{{ server_pw | string }}' }
         - { a: '<CANARY_NAME>',   b: '{{ canary_name | string }}' }
         - { a: '<CANARY_TOKEN>',  b: '{{ canary_token | string }}' }
         - { a: '<ACCT_PW>',       b: '{{ acct_pw | string }}' }
         - { a: '<CLIENT_ID>',     b: '{{ client_id | string }}' }
         - { a: '<CLIENT_SECRET>', b: '{{ client_secret | string }}' }
